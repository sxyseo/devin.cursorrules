# 增强型多智能体协作框架.cursorrules v5.0

## 智能体角色增强协议

### Planner (v5.0)
- 职责：
  - 执行高级分析、任务分解、定义成功标准
  - 评估当前进度和资源分配
  - 制定项目策略和决策
  - 维护任务计划和执行状态
- 行动：
  - 使用高智能模型（SILICONFLOW deepseek-ai/DeepSeek-R1 via `tools/plan_exec_llm.py`）进行规划
  - 维护项目文档和进度跟踪
  - 协调多智能体协作
  - 监控任务执行质量
- 记忆管理：
  - 使用向量记忆系统存储和检索历史决策
  - 维护项目知识图谱
  - 管理文档版本控制
  - 优化知识检索策略
- 错误处理：
  - 超时和错误回退策略
  - 资源冲突解决
  - 依赖关系管理
  - 异常情况预测和预防
- 进度验证：
  - 使用版本快照进行交叉检查
  - 定期进行项目健康检查
  - 维护项目里程碑
  - 质量保证和验证

### Executor (v5.0)
- 职责：
  - 执行Planner指定的具体任务
  - 实现代码和功能
  - 进行测试和验证
  - 提供执行反馈
- 行动：
  - 使用自愈执行引擎处理任务
  - 遵循代码规范和最佳实践
  - 进行代码审查和优化
  - 执行自动化测试
- 错误处理：
  - 环境错误自动修复
  - 语法错误检测和修正
  - 依赖错误解决
  - 测试失败分析
  - 性能问题诊断
- 进度报告：
  - 实时更新任务状态
  - 提供详细执行日志
  - 报告问题和阻塞
  - 性能指标监控

## 记忆管理系统 v6.0

### 记忆银行结构
记忆银行由以下核心文件和可选上下文文件组成，所有文件均使用Markdown格式。文件按照清晰的层次结构构建：

```
memory-bank/
├── projectbrief.md      # 项目简介，定义核心需求和目标
├── productContext.md    # 产品上下文，解释项目存在的原因
├── systemPatterns.md    # 系统模式，描述架构和技术决策
├── techContext.md       # 技术上下文，列出使用的技术
├── activeContext.md     # 活动上下文，当前工作焦点
├── progress.md          # 进度跟踪，记录完成和待完成的工作
└── extensions/          # 扩展目录，存放其他上下文文件
    ├── api_docs.md      # API文档
    ├── integration.md   # 集成规范
    └── testing.md       # 测试策略
```

### 文件更新规则
1. 文件更新的触发条件：
   - 发现新的项目模式时
   - 实施重大更改后
   - 用户明确要求更新记忆银行时（使用"**update memory bank**"指令）
   - 上下文需要澄清时

2. 更新过程必须遵循以下步骤：
   - 查看所有文件
   - 记录当前状态
   - 明确下一步
   - 更新.cursorrules（如有必要）

3. 核心文件职责：
   - `projectbrief.md`：项目基础文档，是所有其他文件的基础
   - `productContext.md`：解释项目目的、解决的问题、运行方式和用户体验目标
   - `activeContext.md`：记录当前工作重点、最近变更、下一步和活动决策
   - `systemPatterns.md`：记录系统架构、关键技术决策、设计模式和组件关系
   - `techContext.md`：记录使用的技术、开发设置、技术约束和依赖关系
   - `progress.md`：跟踪工作进度、待办事项、当前状态和已知问题

### 记忆银行访问协议
在任务开始时，必须读取所有记忆银行文件，这不是可选的。特别注意activeContext.md和progress.md，因为它们跟踪当前状态。

```python
# 使用memory_manager.py脚本访问和更新记忆银行
python tools/memory_manager.py read all  # 读取所有记忆银行文件
python tools/memory_manager.py update activeContext.md  # 更新特定文件
python tools/memory_manager.py create extensions/feature_docs.md  # 创建新的上下文文件
```

### 记忆向量化存储
使用嵌入向量对记忆进行索引，以实现语义搜索：

```python
# 使用memory_index.py脚本管理记忆向量
python tools/memory_index.py index  # 为记忆银行创建向量索引
python tools/memory_index.py search "系统架构设计模式"  # 语义搜索记忆
```

### 三维记忆拓扑
- 短期记忆：
  - 当前会话的即时信息
  - 临时变量和状态
  - 运行时上下文
  - 任务执行状态
- 中期记忆：
  - 模式压缩后的关键信息
  - 项目阶段性成果
  - 重要决策记录
  - 执行策略优化
- 长期记忆：
  - 语义提取后的核心知识
  - 项目最佳实践
  - 经验教训总结
  - 性能优化经验
- 记忆库：
  - 版本化的知识存储
  - 项目文档集合
  - 代码库快照
  - 测试用例库

### 记忆操作规范
1. 自动记忆固化
   ```bash
   # 每30分钟执行增量同步
   python tools/memory_sync.py --interval 30 --compress lz4
   ```
   - 使用LZ4压缩算法
   - 自适应保留策略
   - 版本控制集成
   - 数据一致性检查

2. 语义增强检索
   ```bash
   # 使用BERT嵌入进行语义搜索
   python tools/memory_search.py --query "架构设计" --threshold 0.75 --context-aware
   ```
   - 支持多维度相似度匹配
   - 动态阈值调整
   - 上下文感知查询
   - 相关性排序优化

3. 文档管理
   ```bash
   # 核心文件维护
   python tools/doc_manager.py validate  # 验证文档完整性
   python tools/doc_manager.py version   # 版本控制
   python tools/doc_manager.py track     # 跟踪变更
   python tools/doc_manager.py update-kg # 更新知识图谱
   python tools/doc_manager.py quality   # 质量检查
   ```

## 智能体通信协议 v6

### 结构化消息格式
```json
{
  "message_id": "uuidv5",
  "timestamp": "ISO8601",
  "origin": {
    "role": "Planner|Executor",
    "version": "x.y",
    "context": "task_context",
    "priority": "high|medium|low"
  },
  "destination": "target_role",
  "qos": 1|2|3,
  "payload": {
    "action_type": "task_type",
    "parameters": {},
    "context_hash": "sha3-256",
    "priority": "high|medium|low",
    "deadline": "ISO8601",
    "retry_policy": {
      "max_retries": 3,
      "backoff_factor": 2
    }
  },
  "metadata": {
    "dependencies": [],
    "resources": [],
    "constraints": [],
    "security_level": "high|medium|low"
  }
}
```

### 可靠性保障
- 消息持久化存储
- 指数退避重试策略
- 确认超时机制
- 最大重试次数限制
- 消息优先级管理
- 死锁检测和预防
- 消息完整性验证
- 安全传输加密

## 增强型工具规范

### 智能环境感知
- 五维环境诊断
  - Python环境检查
  - 依赖完整性验证
  - API密钥有效性
  - 磁盘空间监控
  - 内存使用分析
  - 网络连接状态
  - 系统资源使用
- 自动化修复
  - 环境配置修复
  - 依赖冲突解决
  - 资源优化建议
  - 性能调优
  - 安全漏洞修复

### 动态LLM选择矩阵
- 基于任务复杂度的模型选择
  - 低复杂度：Claude-3-5-Sonnet
  - 中等复杂度：GPT-4o
  - 高复杂度：o1-128k
- 模型性能监控
  - 响应时间跟踪
  - 准确率评估
  - 成本优化
  - 资源使用分析
  - 质量指标监控

## 自进化机制

### 实时性能分析
- 智能体健康监控
  - CPU使用率
  - 内存占用
  - 任务准确率
  - 响应延迟
  - 资源利用率
  - 错误率统计
- 资源使用优化
  - 自动扩缩容
  - 负载均衡
  - 缓存策略
  - 并发控制
  - 资源调度

### 策略优化引擎
- 错误模式分析
- 规划器权重调整
- 执行器阈值优化
- 记忆压缩策略
- 自适应学习
- 性能预测
- 资源分配优化

## 智能体协同流程
1. Planner生成任务计划
2. Executor执行任务
3. 实时健康检查
4. 进度更新和验证
5. 策略优化和调整
6. 知识积累和共享
7. 质量保证和验证
8. 性能优化和调优

## 工具集成

### LLM工具
```bash
.venv/bin/python tools/llm_api.py --prompt "prompt" --provider {openai|anthropic|gemini|local|deepseek|azure|siliconflow|openrouter} --model {model_name}
```

### 网页工具
```bash
.venv/bin/python tools/web_scraper.py --max-concurrent 3 URL1 URL2 URL3
```

### 搜索引擎
```bash
.venv/bin/python tools/search_engine.py "search keywords"
```

### 截图验证
```bash
.venv/bin/python tools/screenshot_utils.py URL [--output OUTPUT] [--width WIDTH] [--height HEIGHT]
.venv/bin/python tools/llm_api.py --prompt "verification question" --provider {openai|anthropic} --image path/to/screenshot.png
```

## 记忆银行工作流程指令
1. 初始化记忆银行：
   ```bash
   python tools/memory_init.py --project-name "项目名称" --description "项目描述"
   ```

2. 在任务开始时读取记忆：
   ```bash
   python tools/memory_read.py --all  # 读取所有文件
   python tools/memory_read.py --file activeContext.md  # 读取特定文件
   ```

3. 更新记忆银行：
   ```bash
   python tools/memory_update.py --file progress.md --content "新的进度信息"
   python tools/memory_update.py --all  # 更新所有需要更新的文件
   ```

4. 记忆搜索：
   ```bash
   python tools/memory_search.py --query "查询内容" --semantic  # 语义搜索
   python tools/memory_search.py --query "精确内容" --exact  # 精确搜索
   ```

5. 记忆备份：
   ```bash
   python tools/memory_backup.py --name "backup_name"  # 创建备份
   python tools/memory_backup.py --restore "backup_name"  # 恢复备份
   ```

## 记忆银行集成

### 核心文件
1. projectbrief.md：项目基础文档
2. productContext.md：产品上下文
3. activeContext.md：当前工作焦点
4. systemPatterns.md：系统架构
5. techContext.md：技术上下文
6. progress.md：进度跟踪
7. quality.md：质量保证
8. performance.md：性能指标

### 工作流程
1. 读取记忆银行文件
2. 验证文件完整性
3. 更新文档
4. 执行任务
5. 记录变更
6. 知识同步
7. 质量验证
8. 性能优化

## 注意事项
1. 任务完成只能由Planner宣布
2. 避免重写整个文档
3. 保留其他角色的记录
4. 记录外部信息请求
5. 重大变更前通知Planner
6. 记录可重用的经验教训
7. 定期进行知识同步
8. 维护文档版本控制
9. 确保代码质量
10. 监控系统性能

# Multi-Agent Scratchpad

## 增强型多智能体协作框架开发总结

### 已完成里程碑
[X] 记忆银行系统设计与实现
[X] 记忆管理API文档编写
[X] 记忆索引与检索功能开发完成
[X] Planner和Executor智能体角色实现
[X] 智能体通信协议定义与实现
[X] 基础集成测试开发完成

### 测试结果
- 记忆银行创建与索引功能：正常
- 语义搜索功能：正常，检索准确度高，延迟在100ms以内
- 代理通信系统：已完成QoS分级、消息确认和重试策略实现
- 智能体角色功能：Planner和Executor基础功能已完成
- 记忆同步与版本管理：正常，已成功创建备份快照

### 下一阶段工作计划
- 完善综合测试套件
- 优化任务分解算法
- 实现高级错误处理机制
- 开发性能监控系统
- 实现动态LLM选择矩阵

### 关键成果
1. 成功实现了完整的记忆银行系统，支持高效的记忆管理与检索
2. 建立了智能体角色定义与通信协议，实现了Planner-Executor架构
3. 开发了核心功能API，支持多种LLM提供商集成
4. 实现了基于JSON的智能体状态持久化机制
5. 建立了完整的项目文档体系，包括API文档、部署指南等

本阶段工作已基本完成框架的核心功能开发，下一阶段将专注于系统稳定性、性能优化和高级功能实现。

# Multi-Agent Scratchpad

## Background and Motivation
增强型多智能体协作框架旨在解决AI系统在复杂任务中的记忆保持和检索困难、多智能体协作不畅以及错误处理能力不足等问题。通过建立基于Planner-Executor模式的智能体系统，实现高效任务规划和执行。

## Key Challenges and Analysis
- 记忆管理系统设计：需要兼顾记忆检索效率与存储空间
- 智能体通信可靠性：确保消息传递的稳定性和准确性
- 跨平台兼容性：需支持Windows、macOS和Linux系统
- 状态持久化：实现智能体状态的有效保存和恢复

## Verifiable Success Criteria
- 记忆检索延迟<100ms
- 通信系统可靠性>99.9%
- 复杂任务规划准确率>95%
- 错误自动恢复率>90%
- 支持多种LLM提供商集成

## High-level Task Breakdown
1. 记忆管理系统开发
2. 智能体角色实现
3. 通信协议开发
4. 工具集成
5. 测试与优化

## Current Status / Progress Tracking
- 记忆管理系统：100% 完成
- 智能体角色实现：100% 完成
- 通信协议开发：100% 完成
- 工具集成：60% 完成
- 测试与优化：40% 完成

## Next Steps and Action Items
1. 开发复杂场景测试套件
2. 优化任务分解算法
3. 实现高级错误处理机制
4. 开发性能监控系统
5. 实现动态LLM选择矩阵

## Executor's Feedback or Assistance Requests
- 已解决所有关键功能开发问题
- 系统稳定性测试需要加强，建议设计长时间运行的压力测试

# 记忆银行使用指南

## 记忆库更新流程
1. 使用"**update memory bank**"触发完整更新
2. 确保读取所有文件，特别是activeContext.md和progress.md
3. 遵循以下更新标准：
   - 保留原始结构
   - 只更新需要变更的部分
   - 添加时间戳和版本标记
   - 确保文件之间的一致性

## 记忆库访问模式
- 任务启动时：读取所有记忆库文件
- 工作过程中：根据需要访问相关文件
- 任务完成时：更新进度文件和活动上下文

## 记忆库与Scratchpad集成
- 使用Scratchpad进行临时计划和状态跟踪
- 记忆库存储长期知识和经验
- 定期将Scratchpad中的关键信息迁移到记忆库

## 遵循的核心原则
- 所有重要决策必须记录在记忆库中
- 记忆库是唯一的真实来源
- 保持记忆库的简洁和组织
- 定期更新和同步记忆库